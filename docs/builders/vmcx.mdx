---
modeline: |
  vim: set ft=pandoc:
description: >-
  The Hyper-V Packer builder is able to clone an existing Hyper-V virtual
  machine and export them.
page_title: Hyper-V Builder (from a vmcx)
nav_title: VMCX
---

# Hyper-V Builder (from a vmcx)

Type: `hyperv-vmcx`
Artifact BuilderId: `MSOpenTech.hyperv`

The Hyper-V Packer builder is able to use exported virtual machines or clone
existing
[Hyper-V](https://www.microsoft.com/en-us/server-cloud/solutions/virtualization.aspx)
virtual machines.

Typically, the builder imports or clones an existing virtual machine,
boots it, provisions software within the OS, and then shuts it down. The
result of the Hyper-V builder is a directory containing all the files
necessary to run the virtual machine portably.

## Basic Examples

Import from an exported VM folder:

```hcl
source "hyperv-vmcx" "windows" {
  clone_from_vmcx_path = "c:/exports/windows-2025-base"
  communicator         = "psrp"
  psrp_transport       = "hvsock"
  psrp_username        = "Administrator"
  psrp_password        = var.admin_password
  shutdown_command      = "shutdown /s /t 5 /f"
}
```

Clone from an existing VM by name:

```hcl
source "hyperv-vmcx" "windows" {
  clone_from_vm_name = "windows-2025-base"
  communicator       = "psrp"
  psrp_transport     = "hvsock"
  psrp_username      = "Administrator"
  psrp_password      = var.admin_password
  shutdown_command    = "shutdown /s /t 5 /f"
}
```

By default Packer will perform a hard power off of a virtual machine.
However, when a machine is powered off this way, it is possible that
changes made to the VMs file system may not be fully synced, possibly
leading to corruption of files or lost changes. As such, it is important to
add a `shutdown_command`. This tells Packer how to safely shutdown and
power off the VM.

## Configuration Reference

There are many configuration options available for the Hyper-V builder. They
are organized below into two categories: required and optional. Within each
category, the available options are alphabetized and described.

In addition to the options listed here, a
[communicator](/packer/docs/communicators) can be configured for this
builder. This plugin supports SSH, WinRM, and PSRP communicators.

## ISO Configuration Reference

@include 'packer-plugin-sdk/multistep/commonsteps/ISOConfig.mdx'

### Required:

@include 'packer-plugin-sdk/multistep/commonsteps/ISOConfig-required.mdx'

**Optional:**

@include 'packer-plugin-sdk/multistep/commonsteps/ISOConfig-not-required.mdx'

### Required for virtual machine import:

- `clone_from_vmcx_path` (string) - The path to a directory containing a
  previously exported virtual machine. The exported machine will be used
  as the source for new VM.

  note: You should provide the named directory that contains the
  "Virtual Machines", "Snapshots", and/or "Virtual Hard Disks" subdirectories,
  not the .vmcx file itself.

### Required for virtual machine clone:

- `clone_from_vm_name` (string) - The name of the VM to clone from. Ideally
  the machine to clone from should be shutdown.

**Optional:**

@include 'builder/hyperv/vmcx/Config-not-required.mdx'

@include 'builder/hyperv/common/CommonConfig-not-required.mdx'

### Communicator configuration reference

This plugin supports three communicator types: SSH, WinRM, and PSRP.

For Windows VMs, PSRP with HvSocket transport is recommended as it requires
no network configuration on the guest. See the
[PSRP Communicator](../communicators/psrp.mdx) documentation for details.

@include 'packer-plugin-sdk/communicator/Config-not-required.mdx'

#### SSH fields:

@include 'packer-plugin-sdk/communicator/SSH-not-required.mdx'

@include 'packer-plugin-sdk/communicator/SSH-Private-Key-File-not-required.mdx'

#### WinRM fields:

@include 'packer-plugin-sdk/communicator/WinRM-not-required.mdx'

#### Optional PSRP fields:

@include 'communicator/PSRP-not-required.mdx'

### CD configuration

@include 'packer-plugin-sdk/multistep/commonsteps/CDConfig.mdx'

**Optional:**

@include 'packer-plugin-sdk/multistep/commonsteps/CDConfig-not-required.mdx'

### Boot Configuration Reference

@include 'packer-plugin-sdk/bootcommand/BootConfig.mdx'

**Optional:**

@include 'packer-plugin-sdk/bootcommand/BootConfig-not-required.mdx'

### HTTP directory configuration

@include 'packer-plugin-sdk/multistep/commonsteps/HTTPConfig.mdx'

**Optional:**

@include 'packer-plugin-sdk/multistep/commonsteps/HTTPConfig-not-required.mdx'

## Integration Services

Packer will automatically attach the integration services ISO as a DVD drive
for the version of Hyper-V that is running.

## Generation 1 vs Generation 2

Generation 2 VMs are recommended for modern operating systems. They support
UEFI boot, Secure Boot, and have better performance.

Floppy drives are not supported by generation 2 machines. Use `cd_content`
or `cd_files` to provide answer files instead.

When using Windows with generation 2, enable UEFI drives in your configuration.

## Clone and Customize Example

This example clones an existing Windows VM, provisions it with PSRP over
HvSocket, and runs cleanup scripts:

```hcl
variable "admin_password" {
  type      = string
  default   = env("PKR_ADMIN_PASSWORD")
  sensitive = true
}

source "hyperv-vmcx" "windows-2025" {
  clone_from_vm_name = "windows-2025-base"
  cpus               = 4
  memory             = 4096

  communicator   = "psrp"
  psrp_transport = "hvsock"
  psrp_username  = "Administrator"
  psrp_password  = var.admin_password
  psrp_timeout   = "10m"

  shutdown_command = "shutdown /s /t 5 /f"
}

build {
  sources = ["source.hyperv-vmcx.windows-2025"]

  provisioner "powershell" {
    inline = [
      "Write-Host 'Connected via PSRP HvSocket!'",
      "Write-Host \"OS: $((Get-ComputerInfo).WindowsProductName)\"",
    ]
  }

  provisioner "powershell" {
    scripts = ["scripts/cleanup.ps1"]
  }
}
```
