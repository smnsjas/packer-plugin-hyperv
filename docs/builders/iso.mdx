---
modeline: |
  vim: set ft=pandoc:
description: |
  The Hyper-V Packer builder is able to create Hyper-V virtual machines and
  export them.
page_title: Hyper-V ISO - Builders
nav_title: ISO
---

# Hyper-V Builder (from an ISO)

Type: `hyperv-iso`
Artifact BuilderId: `MSOpenTech.hyperv`

The Hyper-V Packer builder is able to create
[Hyper-V](https://www.microsoft.com/en-us/server-cloud/solutions/virtualization.aspx)
virtual machines and export them, starting from an ISO image.

The builder builds a virtual machine by creating a new virtual machine from
scratch. Typically, the VM is booted, an OS is installed, and software is
provisioned within the OS. Finally the VM is shut down. The result of the
Hyper-V builder is a directory containing all the files necessary to run
the virtual machine portably.

## Basic Example

Here is a basic example for building a Windows Server 2025 image using
PSRP over HvSocket (PowerShell Direct). This requires no network
configuration on the guest VM:

```hcl
source "hyperv-iso" "windows" {
  vm_name      = "windows-2025"
  generation   = 2
  cpus         = 2
  memory       = 4096
  disk_size    = 61440
  switch_name  = "Default Switch"

  iso_url      = "path/to/windows-server-2025.iso"
  iso_checksum = "sha256:..."

  cd_content = {
    "Autounattend.xml" = file("answer_files/Autounattend.xml")
  }

  boot_wait = "1s"
  boot_command = ["<enter><wait><enter><wait><enter>"]

  communicator     = "psrp"
  psrp_transport   = "hvsock"
  psrp_username    = "Administrator"
  psrp_password    = var.admin_password

  shutdown_command = "shutdown /s /t 5 /f"
}

build {
  sources = ["source.hyperv-iso.windows"]

  provisioner "powershell" {
    inline = ["Write-Host 'Build complete'"]
  }
}
```

By default Packer will perform a hard power off of a virtual machine.
However, when a machine is powered off this way, it is possible that
changes made to the VMs file system may not be fully synced, possibly
leading to corruption of files or lost changes. As such, it is important to
add a `shutdown_command`. This tells Packer how to safely shutdown and
power off the VM.

## Configuration Reference

There are many configuration options available for the Hyper-V builder. They
are organized below into two categories: required and optional. Within each
category, the available options are alphabetized and described.

In addition to the options listed here, a
[communicator](/packer/docs/communicators) can be configured for this
builder. This plugin supports SSH, WinRM, and PSRP communicators.

### ISO Configuration Reference

@include 'packer-plugin-sdk/multistep/commonsteps/ISOConfig.mdx'


@include 'packer-plugin-sdk/multistep/commonsteps/ISOConfig-required.mdx'

**Optional:**

@include 'packer-plugin-sdk/multistep/commonsteps/ISOConfig-not-required.mdx'

- `output_directory` (string) - This setting specifies the directory that
artifacts from the build, such as the virtual machine files and disks,
will be output to. The path to the directory may be relative or
absolute. If relative, the path is relative to the working directory
`packer` is executed from. This directory must not exist or, if
created, must be empty prior to running the builder. By default this is
"output-BUILDNAME" where "BUILDNAME" is the name of the build.

@include 'builder/hyperv/iso/Config-not-required.mdx'

@include 'builder/hyperv/common/CommonConfig-not-required.mdx'

### HTTP Directory configuration

@include 'packer-plugin-sdk/multistep/commonsteps/HTTPConfig.mdx'

**Optional:**

@include 'packer-plugin-sdk/multistep/commonsteps/HTTPConfig-not-required.mdx'

### Shutdown configuration reference

@include 'packer-plugin-sdk/shutdowncommand/ShutdownConfig-not-required.mdx'

### Floppy configuration reference

@include 'packer-plugin-sdk/multistep/commonsteps/FloppyConfig.mdx'

**Optional:**

@include 'packer-plugin-sdk/multistep/commonsteps/FloppyConfig-not-required.mdx'

#### CD configuration reference

@include 'packer-plugin-sdk/multistep/commonsteps/CDConfig-not-required.mdx'

### Communicator configuration reference

This plugin supports three communicator types: SSH, WinRM, and PSRP.

For Windows VMs, PSRP with HvSocket transport is recommended as it requires
no network configuration on the guest. See the
[PSRP Communicator](../communicators/psrp.mdx) documentation for details.

#### Optional common fields:

@include 'packer-plugin-sdk/communicator/Config-not-required.mdx'

### Optional SSH fields:

@include 'packer-plugin-sdk/communicator/SSH-not-required.mdx'

@include 'packer-plugin-sdk/communicator/SSH-Private-Key-File-not-required.mdx'

#### Optional WinRM fields:

@include 'packer-plugin-sdk/communicator/WinRM-not-required.mdx'

#### Optional PSRP fields:

@include 'communicator/PSRP-not-required.mdx'

### Boot Configuration Reference

@include 'packer-plugin-sdk/bootcommand/BootConfig.mdx'

**Optional:**

@include 'packer-plugin-sdk/bootcommand/BootConfig-not-required.mdx'

## Integration Services

Packer will automatically attach the integration services ISO as a DVD drive
for the version of Hyper-V that is running.

## Generation 1 vs Generation 2

Generation 2 VMs are recommended for modern operating systems. They support
UEFI boot, Secure Boot, and have better performance.

Floppy drives are not supported by generation 2 machines. Use `cd_content`
or `cd_files` to provide answer files (e.g. `Autounattend.xml`) instead.

When using Windows with generation 2, enable UEFI drives in your configuration.

## Windows Server Example with PSRP/HvSocket

This example demonstrates a complete Windows Server 2025 build using PSRP
over HvSocket. The `Autounattend.xml` is delivered via `cd_content` using
`templatefile()` for zero-touch installation:

```hcl
variable "admin_password" {
  type      = string
  default   = env("PKR_ADMIN_PASSWORD")
  sensitive = true
}

source "hyperv-iso" "windows-2025" {
  vm_name    = "windows-2025-dc"
  generation = 2
  cpus       = 4
  memory     = 4096
  disk_size  = 61440

  enable_secure_boot    = true
  secure_boot_template  = "MicrosoftWindows"

  iso_url      = "path/to/en-us_windows_server_2025.iso"
  iso_checksum = "sha256:..."

  cd_content = {
    "Autounattend.xml" = templatefile("answer_files/Autounattend.xml.pkrtpl", {
      admin_password = var.admin_password
      image_index    = 4  # Datacenter (Desktop Experience)
    })
  }

  boot_wait    = "1s"
  boot_command = ["<enter><wait><enter><wait><enter>"]

  communicator   = "psrp"
  psrp_transport = "hvsock"
  psrp_username  = "Administrator"
  psrp_password  = var.admin_password
  psrp_timeout   = "10m"

  shutdown_command = "shutdown /s /t 5 /f"
}

build {
  sources = ["source.hyperv-iso.windows-2025"]

  provisioner "powershell" {
    inline = [
      "Write-Host 'Connected via PSRP HvSocket!'",
      "Write-Host \"OS: $((Get-ComputerInfo).WindowsProductName)\"",
    ]
  }
}
```

## Windows Server Example with WinRM

For environments that require WinRM (e.g. when a network switch is available
and WinRM is pre-configured in the Autounattend):

```hcl
source "hyperv-iso" "windows-2025" {
  vm_name    = "windows-2025"
  generation = 2
  cpus       = 2
  memory     = 4096
  disk_size  = 61440
  switch_name = "External Switch"

  iso_url      = "path/to/en-us_windows_server_2025.iso"
  iso_checksum = "sha256:..."

  cd_content = {
    "Autounattend.xml" = file("answer_files/Autounattend.xml")
  }

  boot_wait    = "1s"
  boot_command = ["<enter><wait><enter><wait><enter>"]

  communicator   = "winrm"
  winrm_username = "Administrator"
  winrm_password = var.admin_password
  winrm_timeout  = "10m"

  shutdown_command = "shutdown /s /t 5 /f"
}
```

-> **Warning:** If you're setting up WinRM for provisioning, you should turn
it off or restrict its permissions as part of a shutdown script at the end of
Packer's provisioning process. WinRM with Basic auth and `AllowUnencrypted`
should not remain enabled in production images.

## Linux Example with SSH

For Linux guests, SSH is the standard communicator. This example uses
Ubuntu Server 24.04 with autoinstall:

```hcl
source "hyperv-iso" "ubuntu" {
  vm_name    = "ubuntu-2404"
  generation = 2
  cpus       = 2
  memory     = 2048
  disk_size  = 21440
  switch_name = "Default Switch"

  enable_secure_boot   = true
  secure_boot_template = "MicrosoftUEFICertificateAuthority"

  iso_url      = "https://releases.ubuntu.com/24.04/ubuntu-24.04-live-server-amd64.iso"
  iso_checksum = "sha256:..."

  http_directory = "http"

  boot_wait = "5s"
  boot_command = [
    "e<down><down><down><end>",
    " autoinstall ds=nocloud-net\\;s=http://{{ .HTTPIP }}:{{ .HTTPPort }}/",
    "<f10>",
  ]

  communicator = "ssh"
  ssh_username = "packer"
  ssh_password = "packer"
  ssh_timeout  = "30m"

  shutdown_command = "echo 'packer' | sudo -S shutdown -P now"
}
```

-> **Note for \*nix guests:** Packer requires the VM to be running a Hyper-V
KVP daemon to detect the guest IP address. On RHEL-based systems, install
`hyperv-daemons` and enable `hypervkvpd`. On Debian-based systems, install
`linux-cloud-tools-common` for `hv_kvp_daemon`. Without this, Packer will
hang at "Waiting for SSH to become available".

For more information about Hyper-V daemons and supported distributions, see
the [Microsoft docs](https://docs.microsoft.com/en-us/windows-server/virtualization/hyper-v/supported-linux-and-freebsd-virtual-machines-for-hyper-v-on-windows).
